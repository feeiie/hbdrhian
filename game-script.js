const player = document.getElementById("player");
const coins = document.querySelectorAll(".coin");
const goal = document.getElementById("goal");
const clearBox = document.getElementById("clearBox");
const memoryText = document.getElementById("memoryText");
const nextStageBtn = document.getElementById("nextStageBtn");
const introBox = document.getElementById("introBox");
const startBtn = document.getElementById("startBtn");
const haruCounter = document.getElementById("haruCounter");
const coinMessage = document.getElementById("coinMessage");
const coinMessageText = document.getElementById("coinMessageText"); // ÂÆöÁæ©
const quizPopup = document.getElementById("quizPopup");

let collectedCoinIds = JSON.parse(localStorage.getItem("collectedCoins") || "[]");

document.addEventListener("DOMContentLoaded", () => {
  const clickSound = document.getElementById("clickSound");

  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      if (clickSound) {
        clickSound.currentTime = 0;
        clickSound.play().catch(() => {});
      }
    });
  });

  const bgm = document.getElementById("bgm");
  if (bgm) {
    bgm.volume = 0.2;
  }
});



function showQuiz(question, answers, correctAnswer, onComplete, sourceElement = null) {
  clearTimeout(quizTimer);
  clearInterval(countdownInterval);

    // üéµ „ÇØ„Ç§„Ç∫Ë°®Á§∫Èü≥
  const quizOpenSound = document.getElementById("quizOpenSound");
  if (quizOpenSound) quizOpenSound.play();

  quizPopup.innerHTML = ""; // „ÇØ„Ç§„Ç∫ÂÜÖÂÆπ„ÇíÂàùÊúüÂåñ
  quizPopup.dataset.answered = "false"; // Â§öÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢Áî®


  const questionEl = document.createElement("p");
  questionEl.textContent = question;
  quizPopup.appendChild(questionEl);

  answers.forEach(ans => {
    const btn = document.createElement("button");
    btn.textContent = ans;
    btn.className = "quizPopup button"; // ‚Üê „Åì„ÅìÈáçË¶Å
    btn.style.margin = "5px";
    btn.onclick = () => {
      if (quizPopup.dataset.answered === "true") return; // ‰∫åÈáç„ÇØ„É™„ÉÉ„ÇØÈò≤Ê≠¢
      quizPopup.dataset.answered = "true";

      const isCorrect = ans === correctAnswer;

      // üéµ Ê≠£Ëß£ or ‰∏çÊ≠£Ëß£ Èü≥ÂÜçÁîü
  const correctSound = document.getElementById("quizCorrectSound");
  const wrongSound = document.getElementById("quizWrongSound");

  if (isCorrect && correctSound) correctSound.play();
  if (!isCorrect && wrongSound) wrongSound.play();
      // haru„Ç≥„Ç§„É≥Âä†ÁÆóÂá¶ÁêÜÔºàÊ≠£Ëß£‚Üí+1„ÄÅ‰∏çÊ≠£Ëß£‚Üí+0Ôºâ
      haruCount += isCorrect ? 1 : 0;
      localStorage.setItem("haruCount", haruCount);
      if (haruCounter) haruCounter.textContent = `haru: ${haruCount}`;

      // üéâ Ê≠£Ëß£ÊôÇ„Å´Âêπ„ÅçÂá∫„Åó„Å®ÁîªÂÉè„ÇíË°®Á§∫
      if (isCorrect && sourceElement) {
        const memory = sourceElement.dataset.memory || "memory!";
        const image = sourceElement.dataset.img || "";

        const coinMsgText = document.getElementById("coinMessageText");
        const coinMessage = document.getElementById("coinMessage");
        const photoBox = document.getElementById("memoryPhotoBox");
        const coinImage = document.getElementById("memoryPhoto");

        coinMsgText.textContent = memory;
        if (coinImage) coinImage.src = image;
        coinMessage.style.display = "flex";
        photoBox.style.display = "block";
        document.getElementById("closeMemoryPhoto").onclick = () => {
          document.getElementById("memoryPhotoBox").style.display = "none";
        };
        
      }

      alert(isCorrect
        ? "üéâ good girl! one more harucoin"
        : "üò¢ TT no harucoin");

      quizPopup.style.display = "none";
      onComplete(isCorrect);
    };
    quizPopup.appendChild(btn);
  });

  quizPopup.style.display = "block";
}
// ÂàùÊúüÂåñÊôÇ„Å´ÁîªÂÉèË®≠ÂÆöÔºàË∂ÖÈáçË¶ÅÔºâ
document.querySelectorAll(".gallery-item").forEach(item => {
  const imgUrl = item.dataset.img;
  if (imgUrl) {
    item.style.backgroundImage = `url('${imgUrl}')`;
  }

  const id = item.dataset.id;
  const unlocked = JSON.parse(localStorage.getItem("galleryUnlocks") || "[]");
  if (unlocked.includes(id)) {
    item.style.display = "none";
  } else {
    item.style.display = "block";
  }
});

// ÊúÄÂàù„Å´„Ç≥„Ç§„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
coins.forEach(coin => {
  const coinId = coin.dataset.id;
  if (collectedCoinIds.includes(coinId)) {
    coin.classList.add("collected");
    coin.style.display = "none";
  }
});

// haru„Ç´„Ç¶„É≥„Éà„Çí„É≠„Éº„Ç´„É´„Åã„ÇâÂèñÂæó
let haruCount = parseInt(localStorage.getItem("haruCount") || "0");
if (haruCounter) {
  haruCounter.textContent = `haru: ${haruCount}`;
}

let x = 100;
let y = window.innerHeight / 2;
const speed = 5;
let gameStarted = false;

const keys = { w: false, a: false, s: false, d: false };

document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = true;
});
document.addEventListener("keyup", (e) => {
  if (e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = false;
});

const stageMap = {
  "game.html": "game2.html",
  "game2.html": "game3.html",
  "game3.html": "game4.html",
  "game4.html": null,
  "newstage1.html": "newstage2.html",
  "newstage2.html": null  // ‚Üê „Åì„Çå„Åß ending.html „Å´ÈÄ≤„ÇÄÂØæË±°„Å´„Å™„Çã
};


const memoryPerStage = {
  "game.html": "‚úàÔ∏è We had many momery and get good relationship",
  "game2.html": "We met and checked if we love each other",
  "game3.html": "üõ¨ needed to hold our mind that we can meet again TT",
  "game4.html": "üèôÔ∏è Our love story started"
};

function getStageFilename() {
  const path = location.pathname;
  return path.substring(path.lastIndexOf("/") + 1);
}

function getNextStage() {
  const file = getStageFilename();
  return stageMap[file] || null;
}

function showClearScreen() {
  gameStarted = false;
  const file = getStageFilename();
  const memory = memoryPerStage[file] || "Cleared This stage!";
  memoryText.textContent = "Our MemoryÔºö" + memory;
  clearBox.style.display = "flex";
  localStorage.setItem(file + "_cleared", "true");
}

nextStageBtn.addEventListener("click", () => {
  const next = getNextStage();
  const current = getStageFilename();

  if (next) {
    // ÁâπÂà•„Çπ„ÉÜ„Éº„Ç∏„ÉÅ„Çß„ÉÉ„ÇØÔºönewstage1 ‚Üí newstage2
    if (current === "newstage1.html") {
      const purchased = localStorage.getItem("specialStage2Purchased");
      if (purchased === "true") {
        window.location.href = "newstage2.html";
      } else {
        alert("‚ùå You haven't bought this stage yet. go to shop now");
        window.location.href = "haru-coin.html"; // ‚úÖ Âº∑Âà∂ÈÅ∑ÁßªÔºÅ
      }
    } else {
      window.location.href = next;
    }
  } else {
    // „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÂàÜÂ≤ê
    if (current === "newstage2.html") {
      window.location.href = "ending2.html";
    } else {
      window.location.href = "ending.html";
    }
  }
});




if (startBtn) {
  startBtn.addEventListener("click", () => {
    introBox.style.display = "none";
    gameStarted = true;
    gameLoop();
  });
}

function checkCollision(rect1, rect2) {
  return !(
    rect1.right < rect2.left ||
    rect1.left > rect2.right ||
    rect1.bottom < rect2.top ||
    rect1.top > rect2.bottom
  );
}

function gameLoop() {
  if (!gameStarted) {
    requestAnimationFrame(gameLoop);
    return;
  }

  // ‰ªÆ„ÅÆÁßªÂãïÂÖà„ÇíË®àÁÆó
  let nextX = x;
  let nextY = y;

  if (keys.w) nextY -= speed;
  if (keys.s) nextY += speed;
  if (keys.a) nextX -= speed;
  if (keys.d) nextX += speed;

  // ‰ªÆÁßªÂãï„Åó„Å¶Âà§ÂÆö
  player.style.left = nextX + "px";
  player.style.top = nextY + "px";
  const playerRect = player.getBoundingClientRect();

  // ÈöúÂÆ≥Áâ©„Å®„ÅÆË°ùÁ™Å„Çí„ÉÅ„Çß„ÉÉ„ÇØ
  let blocked = false;
  const obstacles = document.querySelectorAll(".obstacle");
  obstacles.forEach(ob => {
    const obsRect = ob.getBoundingClientRect();
    if (checkCollision(playerRect, obsRect)) {
      blocked = true;
    }
  });

  // ÂÆüÁßªÂãïÔºàË°ùÁ™Å„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
  if (!blocked) {
    x = nextX;
    y = nextY;
  }

  // Ë°®Á§∫Êõ¥Êñ∞
  player.style.left = x + "px";
  player.style.top = y + "px";

  // „Ç≥„Ç§„É≥ÂèñÂæóÂá¶ÁêÜ
  coins.forEach((coin) => {
    const coinId = coin.dataset.id;
    const coinRect = coin.getBoundingClientRect();

    if (
      !coin.classList.contains("collected") &&
      !collectedCoinIds.includes(coinId) &&
      checkCollision(playerRect, coinRect)
    ) {
      coin.classList.add("collected");
      coin.style.display = "none";
      haruCount++;
      localStorage.setItem("haruCount", haruCount);
      haruCounter.textContent = `haru: ${haruCount}`;

      // ID„Çí‰øùÂ≠ò
      collectedCoinIds.push(coinId);
      localStorage.setItem("collectedCoins", JSON.stringify(collectedCoinIds));

    
      // „ÇØ„Ç§„Ç∫Âá¶ÁêÜ
       const q = coin.dataset.question;
       const a = coin.dataset.answers?.split(",");
        const c = coin.dataset.correct;
      const memoryMsg = coin.dataset.memory;

      showQuiz(q, a, c, (isCorrect) => {
        if (memoryMsg && coinMessageText && coinMessage) {
          coinMessageText.textContent = memoryMsg;
          coinMessage.style.display = "flex";
        }
      }, coin); // ‚úÖ coin„ÅØ„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÅÆÂ§ñ„ÄÅshowQuiz„ÅÆÁ¨¨5ÂºïÊï∞„Å®„Åó„Å¶Ê∏°„Åô
    }

    }


  );

  if (closeCoinMsg) {
    closeCoinMsg.addEventListener("click", () => {
      coinMessage.style.display = "none";
    });
  }

  // „Ç¥„Éº„É´Âá∫ÁèæÊù°‰ª∂
  const remainingCoins = document.querySelectorAll(".coin:not(.collected)");
  if (remainingCoins.length === 0) {
    goal.style.display = "block";
  }

  const goalRect = goal.getBoundingClientRect();
if (goal.style.display === "block" && checkCollision(playerRect, goalRect)) {
  const goalSound = document.getElementById("goalSound");
  if (goalSound) {
    goalSound.currentTime = 0;
    goalSound.play().catch(() => {});
  }
  showClearScreen();
}

  requestAnimationFrame(gameLoop);

  document.querySelectorAll(".gallery-item").forEach(item => {
  const id = item.dataset.id;
  let unlocked = JSON.parse(localStorage.getItem("galleryUnlocks") || "[]");

  if (unlocked.includes(id)) {
    item.style.display = "none";
    return;
  }

  const rect = item.getBoundingClientRect();
  const playerRect = player.getBoundingClientRect();

  if (checkCollision(playerRect, rect)) {
    const q = item.dataset.question;
    const a = item.dataset.answers?.split(",");
    const c = item.dataset.correct;
    const img = item.dataset.img;
    const memory = item.dataset.memory || "üì∏ Got memory"; // ‚úÖ „Åì„Åì„ÅßÂèñÂæó

    showQuiz(q, a, c, (isCorrect) => {
      if (isCorrect) {
        unlocked.push(id);
        localStorage.setItem("galleryUnlocks", JSON.stringify(unlocked));
        item.style.display = "none";
        const sound = document.getElementById("correctSound");
        if (sound) sound.play();
    
        // „É°„É¢„É™„Éº„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫
        const coinMsgText = document.getElementById("coinMessageText");
        const coinMessage = document.getElementById("coinMessage");
        const memoryText = item.dataset.memory || "ÊÄù„ÅÑÂá∫";
        coinMsgText.textContent = memoryText;
        coinMessage.style.display = "flex";
    
        // ‚úÖ ÊÄù„ÅÑÂá∫ÁîªÂÉèË°®Á§∫Âá¶ÁêÜ ‚Üê‚Üê „Åì„Çå„ÅåÂøÖË¶ÅÔºÅ
        const photoBox = document.getElementById("memoryPhotoBox");
        const coinImage = document.getElementById("memoryPhoto");
        const img = item.dataset.img;
    
        if (coinImage && img) {
          coinImage.src = img;
          photoBox.style.display = "block";
        }
    
        const closeBtn = document.getElementById("closeMemoryPhoto");
        if (closeBtn) {
          closeBtn.onclick = () => {
            photoBox.style.display = "none";
          };
        }
    
      } else {
        alert("‚ùå incorrect! you need to remember!");
      }
    }, item);
    
  }
});


  
  

};

if (goal) {
  goal.addEventListener("click", () => {
    if (goal.style.display === "block") {
      showClearScreen();
    }
  });
}

function goBackStage() {
  const file = getStageFilename();
  const backMap = {
    "game2.html": "game.html",
    "game3.html": "game2.html",
    "game4.html": "game3.html",
    "game.html": "index2.html" // ÊúÄÂàù„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÅØ„Çø„Ç§„Éà„É´„Å∏Êàª„Çã
  };
  const back = backMap[file];
  if (back) {
    window.location.href = back;
  } else {
    alert("you can't back more");
  }
}

document.getElementById("resetHaruBtn").onclick = () => {
  if (confirm("Do you want to reset your coin?")) {
    localStorage.removeItem("haruCount");
    localStorage.removeItem("collectedCoins");
    localStorage.removeItem("galleryUnlocks");
    localStorage.removeItem("attemptedGalleries");
    location.reload();
  }
};

let quizTimer;
let countdownInterval;




